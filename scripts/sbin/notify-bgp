#!/bin/vcli -f

# Script to notify bgp daemon when VRRP state changes.

# **** License ****
# Copyright (c) 2019 AT&T Intellectual Property.
# All rights reserved.
#
# Copyright (c) 2014-2015 by Brocade Communications Systems, Inc.
# All rights reserved.
# 
# SPDX-License-Identifier: GPL-2.0-only
#

attempt=0
success=0

while [[ $attempt -le 50 && $success -lt 1 ]]; do
    if mkdir /tmp/notify-bgp.lock 2>/dev/null; then
        ((success++))
    fi
    ((attempt++))
    sleep 0.05
done

if [ $success -lt 1 ]; then
    logger "notify-bgp failed to obtain lock after $attempt attempts."
    exit 1
fi

logger -p user.debug "Obtained BGP lock after $attempt attempts"

# example of expected args: "INSTANCE vyatta-dp0s3-1 MASTER"
TYPE=$1
NAME=$2
STATE=${3,,}

IFS='-' read -a array <<< "$NAME"

vtysh -c "clear ip bgp interface ${array[1]} vrrp-failover vrrp-group ${array[2]} state $STATE"

rm -rf /tmp/notify-bgp.lock
